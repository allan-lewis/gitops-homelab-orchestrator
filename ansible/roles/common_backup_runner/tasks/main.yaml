---
- name: Ensure rsync is installed
  ansible.builtin.package:
    name: rsync
    state: present

- name: Create base, conf.d, and log dirs
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ backup_runner_base_dir }}"
    - "{{ backup_runner_base_dir }}/backup.conf.d"
    - "{{ backup_runner_log_path | dirname }}"

- name: Render environment file
  ansible.builtin.template:
    src: backup.env.j2
    dest: "{{ backup_runner_base_dir }}/backup.env"
    owner: root
    group: root
    mode: "0640"

- name: Install backup runner script
  ansible.builtin.template:
    src: run-backups.sh.j2
    dest: "{{ backup_runner_script_path }}"
    owner: root
    group: root
    mode: "0755"

- name: Install cron job for backups
  when: backup_runner_cron_enabled | bool
  ansible.builtin.cron:
    name: "backup_runner"
    user: root
    minute: "{{ backup_runner_cron_minute | string }}"
    hour: "{{ backup_runner_cron_hour | string }}"
    job: "{{ backup_runner_script_path }} >/dev/null 2>&1"

- name: Remove cron job when disabled
  when: not (backup_runner_cron_enabled | bool)
  ansible.builtin.cron:
    name: "backup_runner"
    user: root
    state: absent

- name: Ensure logrotate is installed
  ansible.builtin.package:
    name: logrotate
    state: present

- name: Install logrotate policy for backup-run
  ansible.builtin.template:
    src: logrotate-backup-run.j2
    dest: /etc/logrotate.d/backup-run
    owner: root
    group: root
    mode: "0644"
