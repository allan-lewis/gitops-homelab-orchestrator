---
- name: Update pacman cache
  community.general.pacman:
    update_cache: true
  become: true

- name: Install Docker engine (optional)
  community.general.pacman:
    name: "{{ arch_docker_compose_docker_pkg }}"
    state: present
  when: arch_docker_compose_install_docker | bool
  become: true

- name: Install Docker Compose v2 plugin
  community.general.pacman:
    name: "{{ arch_docker_compose_compose_pkg }}"
    state: present
  become: true

- name: Ensure docker group exists
  ansible.builtin.group:
    name: docker
    state: present
  become: true

- name: Add operator users to docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
    state: present
  loop: "{{ arch_docker_compose_operator_users }}"
  when: arch_docker_compose_operator_users | length > 0
  become: true

- name: Enable and start Docker service
  ansible.builtin.service:
    name: docker
    enabled: true
    state: started
  become: true
