---
- name: Ensure base directory exists
  ansible.builtin.file:
    path: "{{ s3_mirror_base_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure log file exists
  ansible.builtin.file:
    path: "{{ s3_mirror_log_path }}"
    state: touch
    owner: root
    group: root
    mode: "0640"

- name: Install s3 mirror script
  ansible.builtin.template:
    src: s3-mirror.sh.j2
    dest: /usr/local/bin/s3-mirror.sh
    owner: root
    group: root
    mode: "0755"

- name: Weekly cron for S3 mirror
  when: s3_mirror_cron.enabled
  ansible.builtin.cron:
    name: "s3-local-mirror"
    user: root
    minute: "{{ s3_mirror_cron.minute }}"
    hour: "{{ s3_mirror_cron.hour }}"
    weekday: "{{ s3_mirror_cron.weekday }}"
    job: "/usr/local/bin/s3-mirror.sh >> {{ s3_mirror_log_path }} 2>&1"

- name: Remove cron when disabled
  when: not s3_mirror_cron.enabled
  ansible.builtin.cron:
    name: "s3-local-mirror"
    user: root
    state: absent
