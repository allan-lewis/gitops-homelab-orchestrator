# .github/workflows/runway-smoke.yml
name: L0 runway smoke (direct HTTPS with CF-Access headers)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/runway-smoke.yml'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/runway-smoke.yml'

concurrency:
  group: l0-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    environment: lab
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check — reach Access app (no Proxmox token needed)
        env:
          PVE_ACCESS_HOST: ${{ secrets.PVE_ACCESS_HOST }}           # e.g. pve-api.example.com (NO scheme)
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}   # ends with .access
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        shell: bash
        run: |
          set -euo pipefail
          HOST="${PVE_ACCESS_HOST#https://}"; HOST="${HOST#http://}"
          if [[ -z "${HOST}" ]]; then echo "PVE_ACCESS_HOST is empty"; exit 1; fi
          echo "Hitting https://${HOST}/ with CF-Access service token headers"
          # Any 2xx/3xx/4xx/5xx is fine — we just need to CONNECT via Access
          curl -I --fail --max-time 15 "https://${HOST}/" \
            -H "CF-Access-Client-Id: ${CF_ACCESS_CLIENT_ID}" \
            -H "CF-Access-Client-Secret: ${CF_ACCESS_CLIENT_SECRET}" \
            >/dev/null
          echo "✅ Access path OK (service token accepted)."