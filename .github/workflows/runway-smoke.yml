name: L0 runway smoke (proxy only)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/runway-smoke.yml'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/runway-smoke.yml'

concurrency:
  group: l0-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    environment: lab
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download cloudflared
        shell: bash
        run: |
          set -euo pipefail
          # Prefer the .tgz; fall back to raw binary if needed
          curl -fsSL -o cloudflared.tgz https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.tgz || true
          if [[ -f cloudflared.tgz ]]; then
            tar -xzf cloudflared.tgz
            mv cloudflared cloudflared.bin
          else
            curl -fsSL -o cloudflared.bin https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
            chmod +x cloudflared.bin
          fi
          ./cloudflared.bin --version

      - name: Start Cloudflare Access client proxy (TCP → localhost:9443)
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          PVE_ACCESS_HOST: ${{ secrets.PVE_ACCESS_HOST }}   # e.g. pve-api.example.com (NO scheme)
        shell: bash
        run: |
          set -euo pipefail
          HOST="${PVE_ACCESS_HOST#https://}"; HOST="${HOST#http://}"
          echo "Using Access hostname: ${HOST}"
          ./cloudflared.bin --version || true

          # Start local TCP forwarder to Access-protected origin (env vars provide creds)
          nohup ./cloudflared.bin access tcp \
            --hostname "${HOST}:443" \
            --listener 127.0.0.1:9443 \
            > cloudflared.log 2>&1 &

          # Wait for listener or fail with logs
          for i in {1..30}; do
            sleep 1
            if nc -z 127.0.0.1 9443 ; then
              echo "cloudflared TCP proxy is up"
              exit 0
            fi
            if ! pgrep -f "cloudflared.bin access tcp" >/dev/null; then
              echo "cloudflared exited early; logs follow:"; sed -n '1,200p' cloudflared.log || true
              exit 1
            fi
          done
          echo "cloudflared TCP proxy failed to start; logs follow:"; sed -n '1,200p' cloudflared.log || true
          exit 1

      - name: Sanity check TLS through proxy (must CONNECT)
        env:
          PVE_ACCESS_HOST: ${{ secrets.PVE_ACCESS_HOST }}
        shell: bash
        run: |
          set -euo pipefail
          HOST="${PVE_ACCESS_HOST#https://}"; HOST="${HOST#http://}"
          echo "Curling via proxy with: --resolve ${HOST}:443:127.0.0.1"
          curl -v --fail-early \
            --resolve "${HOST}:443:127.0.0.1" \
            "https://${HOST}/" -o /dev/null || {
              echo "❌ Could not connect via Access proxy."
              echo "--- cloudflared.log (tail) ---"; tail -n 200 cloudflared.log || true
              exit 1
            }
          echo "✅ Connected to origin through Access proxy (HTTP status code can be 3xx/4xx/5xx and that’s OK here)."

      - name: Call Proxmox /version via proxy
        env:
          PVE_ACCESS_HOST: ${{ secrets.PVE_ACCESS_HOST }}
          PM_TOKEN_ID:     ${{ secrets.PM_TOKEN_ID }}
          PM_TOKEN_SECRET: ${{ secrets.PM_TOKEN_SECRET }}
        shell: bash
        run: |
          set -euo pipefail
          HOST="${PVE_ACCESS_HOST#https://}"; HOST="${HOST#http://}"
          mkdir -p artifacts
          curl -fsS \
            --resolve "${HOST}:443:127.0.0.1" \
            -H "Authorization: PVEAPIToken=${PM_TOKEN_ID}=${PM_TOKEN_SECRET}" \
            "https://${HOST}/api2/json/version" | tee artifacts/pve_version.json
          echo "✅ Proxmox version fetched via Cloudflare Access (TCP proxy)."

      - name: Upload artifact (version response)
        uses: actions/upload-artifact@v4
        with:
          name: pve-version
          path: artifacts/pve_version.json

      - name: Attach cloudflared logs (on failure)
        if: failure()
        shell: bash
        run: |
          echo "--- cloudflared.log ---"
          test -f cloudflared.log && tail -n +500 cloudflared.log || echo "no log"

