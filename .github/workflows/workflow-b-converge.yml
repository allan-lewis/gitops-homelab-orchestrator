name: Workflow B - Converge

on:
  workflow_dispatch:

jobs:
  converge:
    environment: lab
    runs-on:
      - self-hosted
      - Linux
      - X64

    steps:
      - name: Show runner identity
        run: |
          echo "Runner name: $RUNNER_NAME"
          echo "Host: $(hostname)"
          echo "User: $(whoami)"

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify Ansible is available
        run: |
          set -e
          echo "Using ansible from: $(command -v ansible)"
          ansible --version

      - name: Configure SSH key for Ansible
        run: |
          set -euo pipefail

          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

          # Write private key from GitHub environment secret
          cat << 'EOF' > "$HOME/.ssh/id_ed25519"
          ${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}
          EOF

          chmod 600 "$HOME/.ssh/id_ed25519"

          echo "SSH key configured at $HOME/.ssh/id_ed25519"

      - name: Run L3 convergence
        env:
          ANSIBLE_PRIVATE_KEY_FILE: "$HOME/.ssh/id_ed25519"
        run: |
          set -euxo pipefail
          # Assumes make l3-apply uses:
          #   -i ansible/inventories/arch_devops/hosts.ini
          make l3-apply
