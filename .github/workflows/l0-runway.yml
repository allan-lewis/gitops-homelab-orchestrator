name: L4.00 Runway

on:
  workflow_dispatch:

jobs:
  l4-runway:
    runs-on:
      - self-hosted
      - Linux
      - X64

    env:
      PVE_ACCESS_HOST: ${{ secrets.PVE_ACCESS_HOST }}
      PM_TOKEN_ID: ${{ secrets.PM_TOKEN_ID }}
      PM_TOKEN_SECRET: ${{ secrets.PM_TOKEN_SECRET }}
      PVE_NODE: ${{ secrets.PVE_NODE }}

    steps:
      - name: Show runner identity
        run: |
          echo "Runner name: $RUNNER_NAME"
          echo "Host: $(hostname)"
          echo "User: $(whoami)"

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show Make targets (optional)
        run: |
          if [ -f Makefile ]; then
            echo "Make targets:"
            make -n help || true
          else
            echo "No Makefile in repo root"
          fi

      - name: Ensure Ansible is installed
        run: |
          set -e
          if ! command -v ansible >/dev/null 2>&1; then
            echo "Ansible not found, installing..."
            sudo apt update
            sudo apt install -y ansible
          else
            echo "Ansible already installed:"
            ansible --version
          fi

      - name: Run L0 runway
        run: |
          set -euxo pipefail
          make l0-runway
