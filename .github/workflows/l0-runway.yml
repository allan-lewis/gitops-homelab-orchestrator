name: L4A Runway

on:
  workflow_dispatch:

jobs:
  l4-runway:
    runs-on:
      - self-hosted
      - Linux
      - X64

    env:
      PVE_ACCESS_HOST: ${{ secrets.PVE_ACCESS_HOST }}
      PM_TOKEN_ID: ${{ secrets.PM_TOKEN_ID }}
      PM_TOKEN_SECRET: ${{ secrets.PM_TOKEN_SECRET }}
      PVE_NODE: ${{ secrets.PVE_NODE }}
      PVE_STORAGE_ISO: ${{ secrets.PVE_STORAGE_ISO }}
      PVE_STORAGE_VM: ${{ secrets.PVE_STORAGE_VM }}
      PVE_BRIDGE: ${{ secrets.PVE_BRIDGE }}
      L0_MIN_FREE_GIB_ISO: ${{ vars.L0_MIN_FREE_GIB_ISO || '4' }}
      L0_MIN_FREE_PCT_VM:  ${{ vars.L0_MIN_FREE_PCT_VM  || '10' }}
      TEMPLATE_PREFIX:      ${{ vars.TEMPLATE_PREFIX      || 'arch-' }}
      TEMPLATE_RETENTION:   ${{ vars.TEMPLATE_RETENTION   || '3' }}

    steps:
      - name: Show runner identity
        run: |
          echo "Runner name: $RUNNER_NAME"
          echo "Host: $(hostname)"
          echo "User: $(whoami)"

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show Make targets (optional)
        run: |
          if [ -f Makefile ]; then
            echo "Make targets:"
            make -n help || true
          else
            echo "No Makefile in repo root"
          fi

      - name: Verify Ansible is available
        run: |
          set -e
          echo "Using ansible from: $(command -v ansible)"
          ansible --version

      - name: Debug env
        run: |
          env | sort | grep -E 'PVE_|PM_TOKEN|L0|TEMPLATE'

      - name: Run L0 runway
        run: |
          set -euxo pipefail
          make l0-runway
