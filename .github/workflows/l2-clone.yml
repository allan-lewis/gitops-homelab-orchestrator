name: L2 Clone and Inventory

on:
  workflow_dispatch:
    inputs:
      l1_run_id:
        description: "L1 workflow run id to fetch artifacts from"
        required: true
        default: "19316048305"
        type: string
      artifact_name:
        description: "Artifact name produced by L1"
        required: true
        default: "l1-template-artifacts"
        type: string
  workflow_run:
    workflows: ["L1 Template Build"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: l2-plan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  l2:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest
    environment: lab
    timeout-minutes: 45

    env:
      # Secrets used to populate TF_VAR_* for the provider/module
      PVE_ACCESS_HOST: ${{ secrets.PVE_ACCESS_HOST }}
      PM_TOKEN_ID: ${{ secrets.PM_TOKEN_ID }}
      PM_TOKEN_SECRET: ${{ secrets.PM_TOKEN_SECRET }}
      TF_VAR_PROXMOX_VM_PUBLIC_KEY: ${{ secrets.TF_VAR_PROXMOX_VM_PUBLIC_KEY }}

      # Ensure no Doppler in CI
      CI: "true"
      DOPPLER: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve L1 run id and artifact
        id: runid
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
            echo "artifact_name=l1-template-artifacts" >> "$GITHUB_OUTPUT"
          else
            echo "run_id=${{ inputs.l1_run_id }}" >> "$GITHUB_OUTPUT"
            echo "artifact_name=${{ inputs.artifact_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: List artifacts on L1 run
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = Number(`${{ steps.runid.outputs.run_id }}`);
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id
            });
            core.info(`Artifacts on run ${run_id}: ${data.artifacts.map(a => a.name).join(", ")}`);

      - name: Download L1 artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: l1-*
          run-id: ${{ steps.runid.outputs.run_id }}
          repository: ${{ github.repository }}
          merge-multiple: true
          path: l1_artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Locate and stage manifest
        id: stage
        shell: bash
        run: |
          set -euo pipefail
          f="$(find l1_artifacts -type f -name 'manifest.json' | head -n1 || true)"
          if [[ -z "$f" ]]; then
            echo "manifest.json not found in artifact '${{ steps.runid.outputs.artifact_name }}' from run ${{ steps.runid.outputs.run_id }}" >&2
            ls -lahR l1_artifacts || true
            exit 1
          fi
          mkdir -p artifacts/l1_images
          cp -f "$f" artifacts/l1_images/manifest.json
          echo "manifest_path=artifacts/l1_images/manifest.json" >> "$GITHUB_OUTPUT"

      - name: Install prerequisites
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Export TF VARs
        shell: bash
        run: |
          set -euo pipefail
          # Compact JSON for TF var
          echo "TF_VAR_l1_manifest_json=$(jq -c '.' artifacts/l1_images/manifest.json)" >> "$GITHUB_ENV"
          echo "TF_VAR_pve_access_host=${PVE_ACCESS_HOST}" >> "$GITHUB_ENV"
          echo "TF_VAR_pm_token_id=${PM_TOKEN_ID}" >> "$GITHUB_ENV"
          echo "TF_VAR_pm_token_secret=${PM_TOKEN_SECRET}" >> "$GITHUB_ENV"
          echo "TF_VAR_proxmox_vm_public_key=${TF_VAR_PROXMOX_VM_PUBLIC_KEY}" >> "$GITHUB_ENV"

      - name: Terraform init
        working-directory: terraform/l2
        run: |
          set -euo pipefail
          terraform init -input=false

      - name: Terraform validate
        working-directory: terraform/l2
        run: |
          set -euo pipefail
          terraform validate

      - name: Terraform plan
        working-directory: terraform/l2
        run: |
          set -euo pipefail
          terraform plan -out=tfplan

      - name: Terraform apply
        working-directory: terraform/l2
        run: |
          set -euo pipefail
          terraform apply -auto-approve tfplan

      # - name: Capture terraform outputs
      #   id: tfout
      #   working-directory: terraform/l2
      #   run: |
      #     set -euo pipefail
      #     mkdir -p ../../artifacts/l2_inventory
      #     terraform output -json > ../../artifacts/l2_inventory/terraform_outputs.json
      #     cat ../../artifacts/l2_inventory/terraform_outputs.json

      - name: Verify guest agent IP and enrich inventory
        shell: bash
        run: |
          set -euo pipefail

          INV="artifacts/l2_inventory/inventory.json"
          if [[ ! -f "$INV" ]]; then
            echo "inventory.json not found at $INV"
            exit 1
          fi

          : "${PM_TOKEN_ID:?Missing PM_TOKEN_ID}"
          : "${PM_TOKEN_SECRET:?Missing PM_TOKEN_SECRET}"
          : "${PVE_ACCESS_HOST:?Missing PVE_ACCESS_HOST}"

          AUTH="Authorization: PVEAPIToken=${PM_TOKEN_ID}=${PM_TOKEN_SECRET}"
          HOST="${PVE_ACCESS_HOST%/}/api2/json"

          # Iterate each host key in the inventory
          while IFS= read -r host; do
            vmid="$(jq -r --arg h "$host" '.[$h].vm_id' "$INV")"
            node="$(jq -r --arg h "$host" '.[$h].node'   "$INV")"

            if [[ -z "${vmid:-}" || "$vmid" == "null" ]]; then
              echo "no vm_id for host $host in inventory"
              exit 1
            fi
            if [[ -z "${node:-}" || "$node" == "null" ]]; then
              echo "no node for host $host in inventory"
              exit 1
            fi

            echo "Querying guest agent for $host (vmid=$vmid node=$node)"
            resp="$(curl -fsS -H "$AUTH" "$HOST/nodes/$node/qemu/$vmid/agent/network-get-interfaces")"

            # Extract first non-lo IPv4 address
            ip="$(echo "$resp" \
              | jq -r '
                  .data.result[]?
                  | select(.name != "lo")
                  | (.["ip-addresses"] // [])[]?
                  | select(.["ip-address-type"] == "ipv4" and .["ip-address"] != "127.0.0.1")
                  | .["ip-address"]
                ' \
              | head -n1)"

            if [[ -z "${ip:-}" || "$ip" == "null" ]]; then
              echo "no valid IPv4 reported by guest agent for $host"
              echo "full GA response follows:"
              echo "$resp" | jq .
              exit 1
            fi

            echo "guest agent IP for $host: $ip"

            # Update only this host in the inventory
            jq --arg h "$host" --arg ip "$ip" \
              '.[$h] += {guest_agent_ip: $ip, guest_agent_healthy: true}' \
              "$INV" > "$INV.tmp"
            mv "$INV.tmp" "$INV"

          done < <(jq -r 'keys[]' "$INV")

          echo "Updated inventory.json:"
          jq . "$INV"

      - name: Add timestamp and surface outputs
        id: finalize
        shell: bash
        run: |
          set -euo pipefail
          ts="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          jq --arg ts "$ts" '.[] |= . + {created_at: $ts}' artifacts/l2_inventory/inventory.json > artifacts/l2_inventory/inventory.json.tmp
          mv artifacts/l2_inventory/inventory.json.tmp artifacts/l2_inventory/inventory.json

          host="$(jq -r 'keys[0]' artifacts/l2_inventory/inventory.json)"
          vmid="$(jq -r --arg h "$host" '.[$h].vm_id' artifacts/l2_inventory/inventory.json)"
          node="$(jq -r --arg h "$host" '.[$h].node' artifacts/l2_inventory/inventory.json)"
          ip="$(jq -r --arg h "$host" '.[$h].guest_agent_ip' artifacts/l2_inventory/inventory.json)"

          echo "vm_name=$host" >> "$GITHUB_OUTPUT"
          echo "vm_id=$vmid"   >> "$GITHUB_OUTPUT"
          echo "node=$node"   >> "$GITHUB_OUTPUT"
          echo "ip=$ip"       >> "$GITHUB_OUTPUT"

          echo "âœ… L2 summary:"
          echo "  Host: $host"
          echo "  Node: $node"
          echo "  VMID: $vmid"
          echo "  IP: $ip"
          echo "  Created at: $ts"

      - name: List artifacts folder
        run: |
          set -euo pipefail
          echo "Contents of artifacts folder:"
          ls -lahR artifacts || true

      - name: Upload L2 artifacts
        if: ${{ hashFiles('artifacts/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: l2-artifacts
          path: artifacts
          retention-days: 14
