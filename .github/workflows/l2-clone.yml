name: L2 Clone and Inventory

on:
  workflow_dispatch:
    inputs:
      l1_run_id:
        description: "L1 workflow run id to fetch artifacts from"
        required: true
        type: string
      artifact_name:
        description: "Artifact name produced by L1"
        required: true
        default: "l1-template-artifacts"
        type: string
  workflow_run:
    workflows: ["L1 Template Build"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: l2-plan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  l2:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest
    environment: lab
    timeout-minutes: 45

    env:
      # Secrets used to populate TF_VAR_* for the provider/module
      PVE_ACCESS_HOST: ${{ secrets.PVE_ACCESS_HOST }}
      PM_TOKEN_ID: ${{ secrets.PM_TOKEN_ID }}
      PM_TOKEN_SECRET: ${{ secrets.PM_TOKEN_SECRET }}
      TF_VAR_PROXMOX_VM_PUBLIC_KEY: ${{ secrets.TF_VAR_PROXMOX_VM_PUBLIC_KEY }}

      # Ensure no Doppler in CI
      CI: "true"
      DOPPLER: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve L1 run id and artifact
        id: runid
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
            echo "artifact_name=l1-template-artifacts" >> "$GITHUB_OUTPUT"
          else
            echo "run_id=${{ inputs.l1_run_id }}" >> "$GITHUB_OUTPUT"
            echo "artifact_name=${{ inputs.artifact_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: List artifacts on L1 run
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = Number(`${{ steps.runid.outputs.run_id }}`);
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id
            });
            core.info(`Artifacts on run ${run_id}: ${data.artifacts.map(a => a.name).join(", ")}`);

      - name: Download L1 artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: l1-*
          run-id: ${{ steps.runid.outputs.run_id }}
          repository: ${{ github.repository }}
          merge-multiple: true
          path: l1_artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Locate and stage manifest
        id: stage
        shell: bash
        run: |
          set -euo pipefail
          f="$(find l1_artifacts -type f -name 'manifest.json' | head -n1 || true)"
          if [[ -z "$f" ]]; then
            echo "manifest.json not found in artifact '${{ steps.runid.outputs.artifact_name }}' from run ${{ steps.runid.outputs.run_id }}" >&2
            ls -lahR l1_artifacts || true
            exit 1
          fi
          mkdir -p artifacts/l1_images
          cp -f "$f" artifacts/l1_images/manifest.json
          echo "manifest_path=artifacts/l1_images/manifest.json" >> "$GITHUB_OUTPUT"

      - name: Install prerequisites
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Export TF VARs
        shell: bash
        run: |
          set -euo pipefail
          # Compact JSON for TF var
          echo "TF_VAR_l1_manifest_json=$(jq -c '.' artifacts/l1_images/manifest.json)" >> "$GITHUB_ENV"
          echo "TF_VAR_pve_access_host=${PVE_ACCESS_HOST}" >> "$GITHUB_ENV"
          echo "TF_VAR_pm_token_id=${PM_TOKEN_ID}" >> "$GITHUB_ENV"
          echo "TF_VAR_pm_token_secret=${PM_TOKEN_SECRET}" >> "$GITHUB_ENV"
          echo "TF_VAR_proxmox_vm_public_key=${TF_VAR_PROXMOX_VM_PUBLIC_KEY}" >> "$GITHUB_ENV"

      - name: Terraform init
        working-directory: terraform/l2
        run: |
          set -euo pipefail
          terraform init -input=false

      - name: Terraform validate
        working-directory: terraform/l2
        run: |
          set -euo pipefail
          terraform validate

      - name: Terraform plan
        working-directory: terraform/l2
        run: |
          set -euo pipefail
          terraform plan -out=tfplan

      - name: Terraform apply
        working-directory: terraform/l2
        run: |
          set -euo pipefail
          terraform apply -auto-approve tfplan

      - name: List artifacts folder
        run: |
          set -euo pipefail
          echo "Contents of artifacts folder:"
          ls -lahR artifacts || true

      - name: Upload L2 artifacts
        if: ${{ hashFiles('artifacts/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: l2-artifacts
          path: artifacts
          retention-days: 14

      - name: Verify IP via guest agent
        id: ga_check
        shell: bash
        run: |
          set -euo pipefail
          echo "Querying Proxmox guest agent for IP address..."

          # Load VM details from terraform outputs
          vmid="$(jq -r '.vmid.value' terraform/l2/terraform.tfstate)"
          node="$(jq -r '.node.value' terraform/l2/terraform.tfstate)"

          if [[ -z "$vmid" || "$vmid" == "null" ]]; then
            echo "❌ No VMID found in terraform outputs"
            exit 1
          fi
          if [[ -z "$node" || "$node" == "null" ]]; then
            echo "❌ No node found in terraform outputs"
            exit 1
          fi

          AUTH="Authorization: PVEAPIToken=${PM_TOKEN_ID}=${PM_TOKEN_SECRET}"
          HOST="${PVE_ACCESS_HOST%/}/api2/json"

          echo "Fetching GA network interfaces for VMID $vmid on node $node..."
          resp="$(curl -fsS -H "$AUTH" "$HOST/nodes/$node/qemu/$vmid/agent/network-get-interfaces" || true)"

          if [[ -z "$resp" ]]; then
            echo "❌ Guest agent query returned no data"
            exit 1
          fi

          ip="$(echo "$resp" | jq -r '.data[]?."ip-addresses"[]? | select(.["ip-address-type"]=="ipv4" and .["ip-address"]!="127.0.0.1") | .["ip-address"]' | head -n1 || true)"

          if [[ -z "$ip" || "$ip" == "null" ]]; then
            echo "❌ No valid IPv4 address returned by guest agent"
            echo "Full GA response for debugging:"
            echo "$resp" | jq .
            exit 1
          fi

          echo "✅ Guest agent reports IP: $ip"
          echo "ip=$ip" >> "$GITHUB_OUTPUT"

          # Enrich existing inventory files
          jq --arg ip "$ip" '.[] |= . + {ip: $ip, guest_agent_healthy: true}' artifacts/l2_inventory/inventory.json > artifacts/l2_inventory/inventory.json.tmp
          mv artifacts/l2_inventory/inventory.json.tmp artifacts/l2_inventory/inventory.json

          # Update YAML (simple append or rewrite)
          echo "ip: $ip" >> artifacts/l2_inventory/inventory.yaml
          echo "guest_agent_healthy: true" >> artifacts/l2_inventory/inventory.yaml

          echo "Updated inventory:"
          cat artifacts/l2_inventory/inventory.json